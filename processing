Sub FilterSymbolsNettingToZero_V2()

    ' --- MACRO START ---
    ' Purpose: Filters the "REPORT" sheet to only include rows for symbols
    ' where the total sum of "NET QTY DIFF" for that symbol is zero.
    ' V2: Includes more robust error handling.
    
    ' --- Speed Optimization ---
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.DisplayAlerts = False
    
    ' --- Variable Declaration ---
    Dim wsReport As Worksheet
    Dim wsPivot As Worksheet
    Dim wsSymbols As Worksheet
    Dim pvtCache As PivotCache
    Dim pvt As PivotTable
    Dim lastRowReport As Long
    Dim lastRowSymbols As Long
    Dim sourceDataRange As Range
    Dim symbolKeepRange As Range
    Dim finalSum As Double

    ' --- Error Handling Start Point ---
    On Error GoTo ErrorHandler

    ' --- Setup Worksheets ---
    ' Set the main data sheet
    Set wsReport = ThisWorkbook.Sheets("REPORT")
    
    ' Create a temporary sheet for the pivot table
    Set wsPivot = ThisWorkbook.Sheets.Add
    
    ' Create a temporary sheet for symbols to keep
    Set wsSymbols = ThisWorkbook.Sheets.Add

    ' --- Create Pivot Table to Find Symbols That Sum to Zero ---
    ' 1. Define the source data range in the "REPORT" sheet
    lastRowReport = wsReport.Cells(wsReport.Rows.Count, "L").End(xlUp).Row
    Set sourceDataRange = wsReport.Range("A1:T" & lastRowReport)
    
    ' 2. Create a pivot cache (memory for the pivot table)
    Set pvtCache = ThisWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:=sourceDataRange)
    
    ' 3. Create the pivot table on the temporary pivot sheet
    Set pvt = pvtCache.CreatePivotTable(TableDestination:=wsPivot.Range("A3"), TableName:="SymbolSumPivot")
    
    ' 4. Configure the pivot table fields
    With pvt.PivotFields("SYMBOL")
        .Orientation = xlRowField
        .Position = 1
    End With
    With pvt.PivotFields("NET QTY DIFF")
        .Orientation = xlDataField
        .Function = xlSum
        .Name = "Sum of NET QTY DIFF"
    End With

    ' --- Isolate Symbols with a Zero Sum ---
    ' 1. Copy pivot table results to the symbols sheet as values
    wsPivot.Activate
    pvt.TableRange1.Copy
    wsSymbols.Range("A1").PasteSpecial Paste:=xlPasteValues
    
    ' 2. Filter this new list to show only rows where the sum is 0
    lastRowSymbols = wsSymbols.Cells(wsSymbols.Rows.Count, "A").End(xlUp).Row
    wsSymbols.Range("A1:B" & lastRowSymbols).AutoFilter Field:=2, Criteria1:="0"
    
    ' 3. Check if any symbols were found that sum to zero
    On Error Resume Next ' Temporarily ignore errors for the next line
    Set symbolKeepRange = wsSymbols.Range("A2:A" & lastRowSymbols).SpecialCells(xlCellTypeVisible)
    On Error GoTo ErrorHandler ' Restore original error handling
    
    If symbolKeepRange Is Nothing Then
        ' If no symbols netted to zero, inform the user and stop the macro
        MsgBox "No symbols were found with a 'NET QTY DIFF' sum of zero. No changes were made to the report.", vbInformation
        GoTo Cleanup ' Jump to the cleanup section to exit gracefully
    End If
    
    ' --- Filter the Main "REPORT" Sheet ---
    wsReport.Activate
    
    ' 1. Add a helper formula in column AF to identify which rows to keep.
    With wsReport.Range("AF2:AF" & lastRowReport)
        .Formula = "=COUNTIF(" & wsSymbols.Name & "!" & symbolKeepRange.Address & ",L2)"
        .Value = .Value ' Convert formulas to values to speed up filtering
    End With
    
    ' 2. Filter the report to show only rows to be deleted (helper column <> 1)
    wsReport.Range("A1:AF" & lastRowReport).AutoFilter Field:=32, Criteria1:="0"
    
    ' 3. Delete the visible rows (the ones we don't need)
    If wsReport.AutoFilter.Range.Columns(1).SpecialCells(xlCellTypeVisible).Count > 1 Then
        wsReport.Range("A2:A" & lastRowReport).SpecialCells(xlCellTypeVisible).EntireRow.Delete
    End If
    
    ' 4. Clean up: Remove the filter and clear the helper column
    If wsReport.AutoFilterMode Then wsReport.AutoFilterMode = False
    wsReport.Columns("AF").ClearContents
    
    ' --- Final Check ---
    finalSum = Application.WorksheetFunction.Sum(wsReport.Range("T:T"))
    MsgBox "Processing complete." & vbCrLf & "The final sum of 'NET QTY DIFF' is: " & finalSum, vbInformation

Cleanup:
    ' --- Delete Temporary Sheets (if they exist) ---
    If Not wsPivot Is Nothing Then wsPivot.Delete
    If Not wsSymbols Is Nothing Then wsSymbols.Delete
    
    ' --- Restore Excel Settings ---
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.DisplayAlerts = True
    Exit Sub

ErrorHandler:
    ' --- In Case of Error, report the ACTUAL error ---
    MsgBox "An error occurred:" & vbCrLf & vbCrLf & _
           "Error Number: " & Err.Number & vbCrLf & _
           "Description: " & Err.Description, vbCritical
    ' Clean up even if there's an error
    GoTo Cleanup

End Sub
